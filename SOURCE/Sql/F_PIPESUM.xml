<?xml version="1.0" encoding="utf-8" ?>
<System>
	<F_PIPESUM_01>
		DELETE
		FROM F_PIPESUM
		WHERE ADD_PC = ?
	</F_PIPESUM_01>

	--mau noi thuong
	<F_PIPESUM_02>
		INSERT INTO F_PIPESUM(
				CUST_CODE,
				SHIP_NO,
				DRAW_TYPE,
				SIGN_NO,
				AFPR_TYPE,
				PROC_TYPE,
				LCLS_CODE,
				MCLS_CODE,
				SCLS_CODE,
				TYPE_CODE,
				MATER_CODE,
				PDMETER,
				STD_CODE,
				KIND_CODE,
				SIZE_NAME,
				LEN_QTY,
				TLEN_QTY,
				TCS_QTY,
				BLOCK_NAME,
				DRAW_NO,
				WT_QTY,
				ADD_USER,
				ADD_PC,
				ADD_DATE,
				ADD_TIME,
				LASTUP_USER,
				LASTUP_PC,
				LASTUP_DATE,
				LASTUP_TIME,
				DLVR_DATE,
				HURRY_TYPE,
				OBFI_DATE
				)
				SELECT
						H.CUST_CODE,
						H.SHIP_NO,
						H.DRAW_TYPE,
						H.SIGN_NO,
						ISNULL(MD.AFPR_TYPE,'0') AS AFPR_TYPE,
						S.PROC_TYPE,
						S.LCLS_CODE,
						S.MCLS_CODE,
						'' AS SCLS_CODE,
						S.TYPE_CODE,
						S.MATER_CODE,
						S.PDMETER,
						S.STD_CODE,
						'' AS KIND_CODE,
						S.SIZE_NAME,
						0 AS LEN_QTY,
						0 AS TLEN_QTY,
						SUM((CASE MC.OODR_TYPE WHEN '1' THEN 1 ELSE D.CS_QTY END) * S.AMT_QTY) AS TCS_QTY,
						H.BLOCK_NAME,
						H.DRAW_NO,
						ISNULL(MAX(MP.WT_QTY),0) AS WT_QTY
						,?,?,?,?,?,?,?,?,H.DLVR_DATE,H.HURRY_TYPE,H.OBFI_DATE
				FROM 	TR_PIPES AS S 
						LEFT OUTER JOIN TR_PIPEH AS H ON S.MN_NO = H.MN_NO AND S.MN_DATE = H.MN_DATE
						LEFT OUTER JOIN TR_PIPED AS D ON S.MN_NO = D.MN_NO AND S.MN_DATE = D.MN_DATE AND S.PAGE_NO = D.PAGE_NO AND S.TANDB_TYPE = D.TANDB_TYPE
						LEFT OUTER JOIN TR_PIPEMD AS MD ON D.MN_NO = MD.MN_NO AND D.MN_DATE = MD.MN_DATE AND D.PAGE_NO = MD.PAGE_NO AND D.TANDB_TYPE = MD.TANDB_TYPE
						LEFT OUTER JOIN M_CUST AS MC ON H.CUST_CODE = MC.CUST_CODE
						LEFT OUTER JOIN M_MCLS AS MM ON S.LCLS_CODE = MM.LCLS_CODE AND S.MCLS_CODE = MM.MCLS_CODE 
						LEFT JOIN (SELECT MAX(WT_QTY) AS WT_QTY, LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY FROM M_PROD GROUP BY LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY) MP 
									ON MP.LCLS_CODE = S.LCLS_CODE AND MP.MCLS_CODE = S.MCLS_CODE AND MP.TYPE_CODE = S.TYPE_CODE AND MP.MATER_CODE = S.MATER_CODE AND MP.PDMETER = S.PDMETER AND MP.STD_CODE = S.STD_CODE
									AND RTRIM(MP.CUST_CODE) = CASE
										WHEN (RTRIM(MM.SPCL_TYPE) = '1' OR RTRIM(MM.SPCL_TYPE) = '3' ) THEN RTRIM(H.CUST_CODE)
										ELSE ''
										END
									AND MP.KIND_CODE = ''
									AND MP.FREQTY = 0
				WHERE	H.MN_NO = ? AND H.MN_DATE = ?
						AND (H.COMP_TYPE != '9') 
						AND S.LCLS_CODE = '1'
						AND S.MCLS_CODE NOT IN ('14','15','18')
				GROUP BY H.CUST_CODE, H.SHIP_NO, H.DRAW_TYPE, H.SIGN_NO, ISNULL(MD.AFPR_TYPE,'0'), S.PROC_TYPE, S.LCLS_CODE, S.MCLS_CODE, S.TYPE_CODE, S.MATER_CODE,
						S.PDMETER, S.STD_CODE, S.SIZE_NAME, H.BLOCK_NAME, H.DRAW_NO, H.DLVR_DATE, H.HURRY_TYPE, H.OBFI_DATE
	</F_PIPESUM_02>

	--pipe loai thuong
	<F_PIPESUM_03>
		INSERT INTO F_PIPESUM(
				CUST_CODE,
				SHIP_NO,
				DRAW_TYPE,
				SIGN_NO,
				AFPR_TYPE,
				PROC_TYPE,
				LCLS_CODE,
				MCLS_CODE,
				SCLS_CODE,
				TYPE_CODE,
				MATER_CODE,
				PDMETER,
				STD_CODE,
				KIND_CODE,
				SIZE_NAME,
				LEN_QTY,
				TLEN_QTY,
				TCS_QTY,
				BLOCK_NAME,
				DRAW_NO,
				WT_QTY,
				ADD_USER,
				ADD_PC,
				ADD_DATE,
				ADD_TIME,
				LASTUP_USER,
				LASTUP_PC,
				LASTUP_DATE,
				LASTUP_TIME,
				DLVR_DATE,
				HURRY_TYPE,
				OBFI_DATE
				)
			SELECT
					H.CUST_CODE,
					H.SHIP_NO,
					H.DRAW_TYPE,
					H.SIGN_NO,
					ISNULL(MD.AFPR_TYPE,'0') AS AFPR_TYPE,
					S.PROC_TYPE,
					S.LCLS_CODE,
					S.MCLS_CODE,
					'' AS SCLS_CODE,
					S.TYPE_CODE,
					S.MATER_CODE,
					S.PDMETER,
					S.STD_CODE,
					'' AS KIND_CODE,
					S.SIZE_NAME,
					MAX(MCTL.C_DATA) AS LEN_QTY,
					SUM((CASE MC.OODR_TYPE WHEN '1' THEN 1 ELSE D.CS_QTY END) * (CASE	WHEN S.LEN_QTY > S.LENMK_QTY THEN  S.LEN_QTY ELSE S.LENMK_QTY END)) AS TLEN_QTY,
					0 AS TCS_QTY, H.BLOCK_NAME, H.DRAW_NO, ISNULL(MAX(MP.WT_QTY),0) AS WT_QTY
					,?,?,?,?,?,?,?,?,H.DLVR_DATE,H.HURRY_TYPE,H.OBFI_DATE
			FROM    TR_PIPES AS S 
					LEFT OUTER JOIN TR_PIPEH AS H ON S.MN_NO = H.MN_NO AND S.MN_DATE = H.MN_DATE
					LEFT OUTER JOIN TR_PIPED AS D ON S.MN_NO = D.MN_NO AND S.MN_DATE = D.MN_DATE AND S.PAGE_NO = D.PAGE_NO AND S.TANDB_TYPE = D.TANDB_TYPE
					LEFT OUTER JOIN TR_PIPEMD AS MD ON D.MN_NO = MD.MN_NO AND D.MN_DATE = MD.MN_DATE AND D.PAGE_NO = MD.PAGE_NO AND D.TANDB_TYPE = MD.TANDB_TYPE
					LEFT OUTER JOIN M_CUST AS MC ON H.CUST_CODE = MC.CUST_CODE
					LEFT OUTER JOIN M_MCLS AS MM ON S.LCLS_CODE = MM.LCLS_CODE AND S.MCLS_CODE = MM.MCLS_CODE
					LEFT JOIN (SELECT MAX(WT_QTY) AS WT_QTY, LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY FROM M_PROD GROUP BY LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY) MP ON S.LCLS_CODE = MP.LCLS_CODE AND S.MCLS_CODE = MP.MCLS_CODE AND S.TYPE_CODE = MP.TYPE_CODE AND S.MATER_CODE = MP.MATER_CODE AND S.PDMETER = MP.PDMETER AND S.STD_CODE = MP.STD_CODE AND MP.KIND_CODE = ''
						AND RTRIM(MP.CUST_CODE) = CASE
									WHEN (RTRIM(MM.SPCL_TYPE) = '1' OR RTRIM(MM.SPCL_TYPE) = '3' ) THEN RTRIM(H.CUST_CODE)
									ELSE ''
								END
									AND MP.KIND_CODE = ''
									AND MP.FREQTY = 0
									AND S.SIZE_NAME = ''
					LEFT JOIN M_CTL AS MCTL ON MCTL.USERID = 'SYSTEM' AND MCTL.C_KEY = 'PIPE_LEN'
			WHERE H.MN_NO = ? AND H.MN_DATE = ?
					AND (H.COMP_TYPE != '9')
					AND (S.LCLS_CODE = '0')
					AND (MM.SUS_TYPE = '0')
			GROUP BY	H.CUST_CODE, H.SHIP_NO, H.DRAW_TYPE, H.SIGN_NO, ISNULL(MD.AFPR_TYPE,'0'), S.PROC_TYPE, S.LCLS_CODE, S.MCLS_CODE, S.TYPE_CODE, S.MATER_CODE,
					S.PDMETER, S.STD_CODE, S.SIZE_NAME, H.BLOCK_NAME, H.DRAW_NO, H.DLVR_DATE, H.HURRY_TYPE, H.OBFI_DATE
	</F_PIPESUM_03>

	--pipe sus 4000
	<F_PIPESUM_04>
		INSERT INTO F_PIPESUM(
				CUST_CODE,
				SHIP_NO,
				DRAW_TYPE,
				SIGN_NO,
				AFPR_TYPE,
				PROC_TYPE,
				LCLS_CODE,
				MCLS_CODE,
				SCLS_CODE,
				TYPE_CODE,
				MATER_CODE,
				PDMETER,
				STD_CODE,
				KIND_CODE,
				SIZE_NAME,
				LEN_QTY,
				TLEN_QTY,
				TCS_QTY,
				BLOCK_NAME,
				DRAW_NO,
				WT_QTY,
				ADD_USER,
				ADD_PC,
				ADD_DATE,
				ADD_TIME,
				LASTUP_USER,
				LASTUP_PC,
				LASTUP_DATE,
				LASTUP_TIME,
				DLVR_DATE,
				HURRY_TYPE,
				OBFI_DATE
				)
			SELECT
					H.CUST_CODE,
					H.SHIP_NO,
					H.DRAW_TYPE,
					H.SIGN_NO,
					ISNULL(MD.AFPR_TYPE,'0') AS AFPR_TYPE,
					S.PROC_TYPE,
					S.LCLS_CODE,
					S.MCLS_CODE,
					'' AS SCLS_CODE,
					S.TYPE_CODE,
					S.MATER_CODE,
					S.PDMETER,
					S.STD_CODE,
					'1' AS KIND_CODE,
					S.SIZE_NAME,
					MAX(MK.LENTO_QRY) AS LEN_QTY,
					SUM((CASE MC.OODR_TYPE WHEN '1' THEN 1 ELSE D .CS_QTY END) * (CASE	WHEN S.LEN_QTY > S.LENMK_QTY THEN  S.LEN_QTY ELSE S.LENMK_QTY END)) AS TLEN_QTY,
					0 AS TCS_QTY,
					H.BLOCK_NAME,
					H.DRAW_NO,
					ISNULL(MAX(MP.WT_QTY),0) AS WT_QTY
					,?,?,?,?,?,?,?,?,H.DLVR_DATE,H.HURRY_TYPE,H.OBFI_DATE
			FROM TR_PIPES AS S
					LEFT OUTER JOIN TR_PIPEH AS H ON S.MN_NO = H.MN_NO AND S.MN_DATE = H.MN_DATE
					LEFT OUTER JOIN TR_PIPED AS D ON S.MN_NO = D.MN_NO AND S.MN_DATE = D.MN_DATE AND S.PAGE_NO = D.PAGE_NO AND S.TANDB_TYPE = D.TANDB_TYPE
					LEFT OUTER JOIN TR_PIPEMD AS MD ON D.MN_NO = MD.MN_NO AND D.MN_DATE = MD.MN_DATE AND D.PAGE_NO = MD.PAGE_NO AND D.TANDB_TYPE = MD.TANDB_TYPE
					LEFT OUTER JOIN M_CUST AS MC ON H.CUST_CODE = MC.CUST_CODE
					LEFT OUTER JOIN M_MCLS AS MM ON S.LCLS_CODE = MM.LCLS_CODE AND S.MCLS_CODE = MM.MCLS_CODE
					LEFT JOIN (SELECT MAX(WT_QTY) AS WT_QTY, LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY FROM M_PROD GROUP BY LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY) MP ON S.LCLS_CODE = MP.LCLS_CODE AND S.MCLS_CODE = MP.MCLS_CODE AND S.TYPE_CODE = MP.TYPE_CODE AND S.MATER_CODE = MP.MATER_CODE AND S.PDMETER = MP.PDMETER AND S.STD_CODE = MP.STD_CODE
											  AND RTRIM(MP.CUST_CODE) = CASE
												WHEN (RTRIM(MM.SPCL_TYPE) = '1' OR RTRIM(MM.SPCL_TYPE) = '3' ) THEN RTRIM(H.CUST_CODE)
												ELSE ''
												END
											  AND MP.KIND_CODE = '1'
											  AND MP.FREQTY = 0
											  AND S.SIZE_NAME = ''
					LEFT JOIN M_KIND AS MK ON MK.KIND_CODE = '1'
			WHERE	H.MN_NO = ? AND H.MN_DATE = ?
					AND (H.COMP_TYPE != '9')
					AND (S.LCLS_CODE = '0')
					AND (MM.SUS_TYPE = '1') AND (MK.KIND_CODE = '1') AND (4005 >= S.LEN_QTY)
			GROUP BY H.CUST_CODE, H.SHIP_NO, H.DRAW_TYPE, H.SIGN_NO, ISNULL(MD.AFPR_TYPE,'0'), S.PROC_TYPE, S.LCLS_CODE, S.MCLS_CODE, S.TYPE_CODE, S.MATER_CODE,
					S.PDMETER, S.STD_CODE, S.SIZE_NAME, H.BLOCK_NAME, H.DRAW_NO, H.DLVR_DATE, H.HURRY_TYPE, H.OBFI_DATE
	</F_PIPESUM_04>

	--pipe sus 6000
	<F_PIPESUM_05>
		INSERT INTO F_PIPESUM(
				CUST_CODE,
				SHIP_NO,
				DRAW_TYPE,
				SIGN_NO,
				AFPR_TYPE,
				PROC_TYPE,
				LCLS_CODE,
				MCLS_CODE,
				SCLS_CODE,
				TYPE_CODE,
				MATER_CODE,
				PDMETER,
				STD_CODE,
				KIND_CODE,
				SIZE_NAME,
				LEN_QTY,
				TLEN_QTY,
				TCS_QTY,
				BLOCK_NAME,
				DRAW_NO,
				WT_QTY,
				ADD_USER,
				ADD_PC,
				ADD_DATE,
				ADD_TIME,
				LASTUP_USER,
				LASTUP_PC,
				LASTUP_DATE,
				LASTUP_TIME,
				DLVR_DATE,
				HURRY_TYPE,
				OBFI_DATE
			)
			SELECT
				H.CUST_CODE,
				H.SHIP_NO,
				H.DRAW_TYPE,
				H.SIGN_NO,
				ISNULL(MD.AFPR_TYPE,'0') AS AFPR_TYPE,
				S.PROC_TYPE,
				S.LCLS_CODE,
				S.MCLS_CODE,
				'' AS SCLS_CODE,
				S.TYPE_CODE,
				S.MATER_CODE,
				S.PDMETER,
				S.STD_CODE,
				'2' AS KIND_CODE,
				S.SIZE_NAME,
				MAX(MK.LENTO_QRY) AS LEN_QTY,
				SUM((CASE MC.OODR_TYPE WHEN '1' THEN 1 ELSE D .CS_QTY END) * (CASE	WHEN S.LEN_QTY > S.LENMK_QTY THEN  S.LEN_QTY ELSE S.LENMK_QTY END)) AS TLEN_QTY,
				0 AS TCS_QTY,
				H.BLOCK_NAME,
				H.DRAW_NO,
				ISNULL(MAX(MP.WT_QTY),0) AS WT_QTY
				,?,?,?,?,?,?,?,?,H.DLVR_DATE,H.HURRY_TYPE,H.OBFI_DATE
			FROM TR_PIPES AS S
				LEFT OUTER JOIN TR_PIPEH AS H ON S.MN_NO = H.MN_NO AND S.MN_DATE = H.MN_DATE
				LEFT OUTER JOIN TR_PIPED AS D ON S.MN_NO = D.MN_NO AND S.MN_DATE = D.MN_DATE AND S.PAGE_NO = D.PAGE_NO AND S.TANDB_TYPE = D.TANDB_TYPE
				LEFT OUTER JOIN TR_PIPEMD AS MD ON D.MN_NO = MD.MN_NO AND D.MN_DATE = MD.MN_DATE AND D.PAGE_NO = MD.PAGE_NO AND D.TANDB_TYPE = MD.TANDB_TYPE
				LEFT OUTER JOIN M_CUST AS MC ON H.CUST_CODE = MC.CUST_CODE
				LEFT OUTER JOIN M_MCLS AS MM ON S.LCLS_CODE = MM.LCLS_CODE AND S.MCLS_CODE = MM.MCLS_CODE
				LEFT JOIN (SELECT MAX(WT_QTY) AS WT_QTY, LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY FROM M_PROD GROUP BY LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY) MP ON S.LCLS_CODE = MP.LCLS_CODE AND S.MCLS_CODE = MP.MCLS_CODE AND S.TYPE_CODE = MP.TYPE_CODE AND S.MATER_CODE = MP.MATER_CODE AND S.PDMETER = MP.PDMETER AND S.STD_CODE = MP.STD_CODE
										  AND RTRIM(MP.CUST_CODE) = CASE
											WHEN (RTRIM(MM.SPCL_TYPE) = '1' OR RTRIM(MM.SPCL_TYPE) = '3' ) THEN RTRIM(H.CUST_CODE)
											ELSE ''
											END
										  AND MP.KIND_CODE = '2'
										  AND MP.FREQTY = 0
										  AND S.SIZE_NAME = ''
				LEFT JOIN M_KIND AS MK ON MK.KIND_CODE = '2'
			WHERE H.MN_NO = ? AND H.MN_DATE = ?
				AND (H.COMP_TYPE != '9')
				AND (S.LCLS_CODE = '0')
				AND (MM.SUS_TYPE = '1') AND (MK.KIND_CODE = '2') AND (S.LEN_QTY > 4005)
			GROUP BY H.CUST_CODE, H.SHIP_NO, H.DRAW_TYPE, H.SIGN_NO, ISNULL(MD.AFPR_TYPE,'0'), S.PROC_TYPE, S.LCLS_CODE, S.MCLS_CODE, S.TYPE_CODE, S.MATER_CODE,
					S.PDMETER, S.STD_CODE, S.SIZE_NAME, H.BLOCK_NAME, H.DRAW_NO, H.DLVR_DATE, H.HURRY_TYPE, H.OBFI_DATE
	</F_PIPESUM_05>

	--mau noi dac biet co chieu dai
	<F_PIPESUM_06>
		INSERT INTO F_PIPESUM(
				CUST_CODE,
				SHIP_NO,
				DRAW_TYPE,
				SIGN_NO,
				AFPR_TYPE,
				PROC_TYPE,
				LCLS_CODE,
				MCLS_CODE,
				SCLS_CODE,
				TYPE_CODE,
				MATER_CODE,
				PDMETER,
				STD_CODE,
				KIND_CODE,
				SIZE_NAME,
				LEN_QTY,
				TLEN_QTY,
				TCS_QTY,
				BLOCK_NAME,
				DRAW_NO,
				WT_QTY,
				ADD_USER,
				ADD_PC,
				ADD_DATE,
				ADD_TIME,
				LASTUP_USER,
				LASTUP_PC,
				LASTUP_DATE,
				LASTUP_TIME,
				DLVR_DATE,
				HURRY_TYPE,
				OBFI_DATE
				)
		SELECT
			H.CUST_CODE,
			H.SHIP_NO,
			H.DRAW_TYPE,
			H.SIGN_NO,
			ISNULL(MD.AFPR_TYPE,'0') AS AFPR_TYPE,
			S.PROC_TYPE,
			S.LCLS_CODE,
			S.MCLS_CODE,
			'' AS SCLS_CODE,
			S.TYPE_CODE,
			S.MATER_CODE,
			S.PDMETER,
			S.STD_CODE,
			'' AS KIND_CODE,
			S.SIZE_NAME,
			MAX(MCTL.C_DATA) AS LEN_QTY,
			SUM((CASE MC.OODR_TYPE WHEN '1' THEN 1 ELSE D.CS_QTY END) * (CASE	WHEN S.LEN_QTY > S.LENMK_QTY THEN  S.LEN_QTY ELSE S.LENMK_QTY END)) AS TLEN_QTY,
			0 AS TCS_QTY,
			H.BLOCK_NAME,
			H.DRAW_NO,
			ISNULL(MAX(MP.WT_QTY),0) AS WT_QTY
			,?,?,?,?,?,?,?,?,H.DLVR_DATE,H.HURRY_TYPE,H.OBFI_DATE
		FROM TR_PIPES AS S
			LEFT OUTER JOIN TR_PIPEH AS H ON S.MN_NO = H.MN_NO AND S.MN_DATE = H.MN_DATE
			LEFT OUTER JOIN TR_PIPED AS D ON S.MN_NO = D.MN_NO AND S.MN_DATE = D.MN_DATE AND S.PAGE_NO = D.PAGE_NO AND S.TANDB_TYPE = D.TANDB_TYPE
			LEFT OUTER JOIN TR_PIPEMD AS MD ON D.MN_NO = MD.MN_NO AND D.MN_DATE = MD.MN_DATE AND D.PAGE_NO = MD.PAGE_NO AND D.TANDB_TYPE = MD.TANDB_TYPE
			LEFT OUTER JOIN M_CUST AS MC ON H.CUST_CODE = MC.CUST_CODE
			LEFT OUTER JOIN M_MCLS AS MM ON S.LCLS_CODE = MM.LCLS_CODE AND S.MCLS_CODE = MM.MCLS_CODE 
			LEFT JOIN (SELECT MAX(WT_QTY) AS WT_QTY, LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY FROM M_PROD GROUP BY LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY)
					MP ON MP.LCLS_CODE = S.LCLS_CODE AND MP.MCLS_CODE = S.MCLS_CODE AND MP.TYPE_CODE = S.TYPE_CODE AND MP.MATER_CODE = S.MATER_CODE AND MP.PDMETER = S.PDMETER AND MP.STD_CODE = S.STD_CODE
					AND RTRIM(MP.CUST_CODE) = CASE
												WHEN (RTRIM(MM.SPCL_TYPE) = '1' OR RTRIM(MM.SPCL_TYPE) = '3' ) THEN RTRIM(H.CUST_CODE)
												ELSE ''
											END
					AND MP.KIND_CODE = ''
					AND MP.FREQTY = 0
			LEFT JOIN M_CTL AS MCTL ON MCTL.USERID = 'SYSTEM' AND MCTL.C_KEY = 'PIPE_LEN'
			WHERE	H.MN_NO = ? AND H.MN_DATE = ?
					AND  (H.COMP_TYPE != '9')
					AND (S.LCLS_CODE = '1')
					AND (S.MCLS_CODE = '14' or S.MCLS_CODE = '15' or S.MCLS_CODE = '18')
			GROUP BY	H.CUST_CODE, H.SHIP_NO, H.DRAW_TYPE, H.SIGN_NO, ISNULL(MD.AFPR_TYPE,'0'), S.PROC_TYPE, S.LCLS_CODE, S.MCLS_CODE, S.TYPE_CODE, S.MATER_CODE,
						S.PDMETER, S.STD_CODE, S.SIZE_NAME, H.BLOCK_NAME, H.DRAW_NO, H.DLVR_DATE, H.HURRY_TYPE, H.OBFI_DATE
	</F_PIPESUM_06>
	
	--mau noi dac biet LCLS_CODE = 2
	<F_PIPESUM_07>
		INSERT INTO F_PIPESUM(
				CUST_CODE,
				SHIP_NO,
				DRAW_TYPE,
				SIGN_NO,
				AFPR_TYPE,
				PROC_TYPE,
				LCLS_CODE,
				MCLS_CODE,
				SCLS_CODE,
				TYPE_CODE,
				MATER_CODE,
				PDMETER,
				STD_CODE,
				KIND_CODE,
				SIZE_NAME,
				LEN_QTY,
				TLEN_QTY,
				TCS_QTY,
				BLOCK_NAME,
				DRAW_NO,
				WT_QTY,
				ADD_USER,
				ADD_PC,
				ADD_DATE,
				ADD_TIME,
				LASTUP_USER,
				LASTUP_PC,
				LASTUP_DATE,
				LASTUP_TIME,
				DLVR_DATE,
				HURRY_TYPE,
				OBFI_DATE
				)
				SELECT
						H.CUST_CODE,
						H.SHIP_NO,
						H.DRAW_TYPE,
						H.SIGN_NO,
						ISNULL(MD.AFPR_TYPE,'0') AS AFPR_TYPE,
						S.PROC_TYPE,
						S.LCLS_CODE,
						S.MCLS_CODE,
						'' AS SCLS_CODE,
						S.TYPE_CODE,
						S.MATER_CODE,
						S.PDMETER,
						S.STD_CODE,
						'' AS KIND_CODE,
						S.SIZE_NAME,
						0 AS LEN_QTY,
						0 AS TLEN_QTY,
						SUM((CASE MC.OODR_TYPE WHEN '1' THEN 1 ELSE D.CS_QTY END) * S.AMT_QTY) AS TCS_QTY,
						H.BLOCK_NAME,
						H.DRAW_NO,
						ISNULL(MAX(MP.WT_QTY),0) AS WT_QTY
						,?,?,?,?,?,?,?,?,H.DLVR_DATE,H.HURRY_TYPE,H.OBFI_DATE
				FROM 	TR_PIPES AS S 
						LEFT OUTER JOIN TR_PIPEH AS H ON S.MN_NO = H.MN_NO AND S.MN_DATE = H.MN_DATE
						LEFT OUTER JOIN TR_PIPED AS D ON S.MN_NO = D.MN_NO AND S.MN_DATE = D.MN_DATE AND S.PAGE_NO = D.PAGE_NO AND S.TANDB_TYPE = D.TANDB_TYPE
						LEFT OUTER JOIN TR_PIPEMD AS MD ON D.MN_NO = MD.MN_NO AND D.MN_DATE = MD.MN_DATE AND D.PAGE_NO = MD.PAGE_NO AND D.TANDB_TYPE = MD.TANDB_TYPE
						LEFT OUTER JOIN M_CUST AS MC ON H.CUST_CODE = MC.CUST_CODE
						LEFT OUTER JOIN M_MCLS AS MM ON S.LCLS_CODE = MM.LCLS_CODE AND S.MCLS_CODE = MM.MCLS_CODE 
						LEFT JOIN (SELECT MAX(WT_QTY) AS WT_QTY, LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY FROM M_PROD GROUP BY LCLS_CODE, MCLS_CODE, TYPE_CODE, MATER_CODE, PDMETER, STD_CODE, CUST_CODE, KIND_CODE, FREQTY) MP 
									ON MP.LCLS_CODE = S.LCLS_CODE AND MP.MCLS_CODE = S.MCLS_CODE AND MP.TYPE_CODE = S.TYPE_CODE AND MP.MATER_CODE = S.MATER_CODE AND MP.PDMETER = S.PDMETER AND MP.STD_CODE = S.STD_CODE
									AND RTRIM(MP.CUST_CODE) = CASE
										WHEN (RTRIM(MM.SPCL_TYPE) = '1' OR RTRIM(MM.SPCL_TYPE) = '3' ) THEN RTRIM(H.CUST_CODE)
										ELSE ''
										END
									AND MP.KIND_CODE = ''
									AND MP.FREQTY = 0
				WHERE	H.MN_NO = ? AND H.MN_DATE = ?
						AND (H.COMP_TYPE != '9')
						AND (S.LCLS_CODE = '2')
				GROUP BY H.CUST_CODE, H.SHIP_NO, H.DRAW_TYPE, H.SIGN_NO, ISNULL(MD.AFPR_TYPE,'0'), S.PROC_TYPE, S.LCLS_CODE, S.MCLS_CODE, S.TYPE_CODE, S.MATER_CODE,
						S.PDMETER, S.STD_CODE, S.SIZE_NAME, H.BLOCK_NAME, H.DRAW_NO, H.DLVR_DATE, H.HURRY_TYPE, H.OBFI_DATE
	</F_PIPESUM_07>
</System>